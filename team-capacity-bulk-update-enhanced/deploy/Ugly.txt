<!DOCTYPE html>
<html>
<head>
    <title>team-capacity-bulk-update-enhanced</title>
    <!--  (c) 2017 CA Technologies.  All Rights Reserved. -->
    <!--  Build Date: Wed Jan 11 2017 15:08:29 GMT-0800 (PST) -->
    
    <script type="text/javascript">
        var APP_BUILD_DATE = "Wed Jan 11 2017 15:08:29 GMT-0800 (PST)";
        var STORY    = "US";
        var BUILDER  = "arajaraman";
        var CHECKSUM = 8003628537;
    </script>
    
    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>
    <!-- our highcharts (needed so that we can add patterns) 
    <script type="text/javascript" src="/apps/2.1/lib/analytics/analytics-all.js"></script>
    -->
    
    
    <script type="text/javascript">
        Rally.onReady(function() {
            Ext.define("Rally.technicalservices.InfoLink",{extend:"Rally.ui.dialog.Dialog",alias:"widget.tsinfolink",informationHtml:null,title:"Build Information",defaults:{padding:5,margin:5},closable:!0,draggable:!0,autoShow:!0,width:350,informationalConfig:null,items:[{xtype:"container",itemId:"information"}],initComponent:function(){Ext.id(this);this.title="<span class='icon-help'> </span>"+this.title,this.callParent(arguments)},_generateChecksum:function(a){var b,c=305419896;for(a=a.replace(/var CHECKSUM = .*;/,""),a=a.replace(/var BUILDER  = .*;/,""),a=a.replace(/\s/g,""),b=0;b<a.length;b++)c+=a.charCodeAt(b)*b;return c},_checkChecksum:function(a){var b=Ext.create("Deft.Deferred"),c=this;return Ext.Ajax.request({url:document.URL,params:{id:1},success:function(a){if(text=a.responseText,CHECKSUM){var d=c._generateChecksum(text);if(CHECKSUM!==d)return void b.resolve(!1)}b.resolve(!0)}}),b.promise},_addToContainer:function(a){var b=Ext.apply({xtype:"container",height:200,overflowY:!0},this.informationalConfig);a.add(b)},afterRender:function(){var a=Rally.getApp();if(!Ext.isEmpty(this.informationalConfig)){var b=this.down("#information");this._addToContainer(b)}a.isExternal()?this.addDocked({xtype:"container",cls:"build-info",padding:2,dock:"bottom",html:"... Running externally"}):this._checkChecksum(a).then({scope:this,success:function(a){a||this.addDocked({xtype:"container",cls:"build-info",dock:"bottom",padding:2,html:'<span class="icon-warning"> </span>Checksums do not match'})},failure:function(a){console.log("oops:",a)}}),this.callParent(arguments)},beforeRender:function(){if(this.callParent(arguments),this.informationHtml&&this.addDocked({xtype:"component",componentCls:"intro-panel",padding:2,html:this.informationHtml,doc:"top"}),this.addDocked({xtype:"container",cls:"build-info",padding:2,dock:"bottom",html:"This app was created by the CA AC Technical Services Team."}),APP_BUILD_DATE){var a=Ext.String.format("Built on: {0} <br/>Built by: {1}",APP_BUILD_DATE,BUILDER);STORY&&(a=a+"<br/>Source story: "+STORY),this.addDocked({xtype:"container",cls:"build-info",padding:2,dock:"bottom",html:a})}}}),Ext.define("Rally.technicalservices.Logger",{constructor:function(a){Ext.apply(this,a)},log:function(a){var b="[ "+Ext.util.Format.date(new Date,"Y-m-d H:i:s.u")+" ]",c=[];c=Ext.Array.push(c,[b]),c=Ext.Array.push(c,Ext.Array.slice(arguments,0)),window.console&&console.log.apply(console,c)}});var _loadAStoreWithAPromise=function(a,b,c,d,e){var f=Ext.create("Deft.Deferred"),g={model:a,fetch:b,filters:c,limit:"Infinity"};return _.isUndefined(d)||_.isNull(d)||(g.context=d),_.isUndefined(e)||_.isNull(e)||(g.order=e),Ext.create("Rally.data.wsapi.Store",g).load({callback:function(a,b,c){c?f.resolve(a):f.reject("Problem loading: "+b.error.errors.join(". "))}}),f.promise},createIterationCapacityFilter=function(a){var b=null;return _.each(a,function(a,c){var d=Ext.create("Rally.data.wsapi.Filter",{property:"Iteration",operator:"=",value:a.get("_ref")});b=0===c?d:b.or(d)}),console.log("Capacity Filter:",b.toString()),b},workingDaysBetweenDates=function(a,b){if(a>b)return 0;var c=864e5;a.setHours(0,0,0,1),b.setHours(23,59,59,999);var d=b-a,e=Math.ceil(d/c),f=Math.floor(e/7);e-=2*f;var g=a.getDay(),h=b.getDay();return g-h>1&&(e-=2),0==g&&6!=h&&(e-=1),6==h&&0!=g&&(e-=1),e},app=null;Ext.define("TSApp",{extend:"Rally.app.TimeboxScopedApp",componentCls:"app",scopeType:"release",devMode:!1,config:{defaultSettings:{maxIterations:5}},onScopeChange:function(a){app=this,app.setupDateFormat();var b=parseInt(app.getSetting("maxIterations"));app.maxIterations=_.isNaN(b)?app.config.defaultSettings.maxIterations:b,console.log("scope",a.getType(),a),console.log("scope",a.getRecord()),app.devMode===!0?app.release={Name:"Release 1",ReleaseDate:"2016-05-15T06:59:59.000Z",ReleaseStartDate:"2016-02-15T06:00:00.000Z"}:(app.release=_.isUndefined(a)?null:a.getRecord().raw,app.scope=a),app.run()},setupDateFormat:function(){app.dformat=app.getContext().getWorkspace().WorkspaceConfiguration.DateFormat,app.extDateFormat="MM/dd/yyyy"===app.dformat?"m/d":"d/m"},run:function(){Deft.Chain.pipeline([this._getRelease,this._loadCapacityModel,this._loadReleases,this._loadIterations,this._loadTeamMembers,this._loadCapacities,this._createCapacityData,this._createCapacityGrid]).then({success:function(a){app.bundle=a,console.log(a)},failure:function(a){console.log("failure",a),app.add({text:a})}})},_getRelease:function(){console.log("_getRelease");var a=Ext.create("Deft.Deferred");return a.resolve({release:app.release,scope:app.scope}),a.promise},_loadCapacityModel:function(a){console.log("_loadCapacityModel");var b=Ext.create("Deft.Deferred");return Rally.data.ModelFactory.getModel({type:"UserIterationCapacity",success:function(c){a.userIterationCapacityModel=c,b.resolve(a)}}),b.promise},_loadReleases:function(a){console.log("_loadReleases",a);var b=a.release,c=Ext.create("Deft.Deferred");return _loadAStoreWithAPromise("Release",(!0)[{property:"Name",operator:"=",value:b.Name}]).then({success:function(b){a.releases=b,c.resolve(a)},failure:function(a){c.reject(a)}}),c.promise},createIterationQuery:function(a){return"release"===a.getType()?[{property:"EndDate",operator:"<=",value:a.getRecord().get("ReleaseDate")},{property:"EndDate",operator:">",value:a.getRecord().get("ReleaseStartDate")}]:[{property:"StartDate",operator:">=",value:a.getRecord().get("StartDate")}]},_loadIterations:function(a){console.log("_loadIterations");var b=(a.release,Ext.create("Deft.Deferred")),c=app.createIterationQuery(a.scope);return console.log("Iteration Query",c),_loadAStoreWithAPromise("Iteration",["Name","StartDate","EndDate"],c,{projectScopeDown:!1},"StartDate").then({success:function(c){c=_.sortBy(c,function(a){return a.get("StartDate")}),console.log(_.map(_.clone(c),function(a){return a.get("Name")})),"iteration"===a.scope.getType()&&(c=c.slice(0,app.maxIterations)),console.log("Iterations",c),a.iterations=c,console.log(_.map(c,function(a){return a.get("Name")})),c.length>0?b.resolve(a):b.reject("No iterations found")},failure:function(a){console.log("failure",a),b.reject(a)}}),b.promise},_loadTeamMembers:function(a){console.log("_loadTeamMembers");var b=Ext.create("Deft.Deferred");return _loadAStoreWithAPromise("Project",["Name","ObjectID","TeamMembers"],[{property:"ObjectID",operator:"=",value:app.getContext().getProject().ObjectID}],{projectScopeDown:!1},"EndDate").then({success:function(c){a.project=_.first(c),a.project.getCollection("TeamMembers").load({fetch:!0,callback:function(c,d,e){e?(a.teamMembers=c,b.resolve(a)):b.reject("No TeamMembers")}})},failure:function(a){b.reject(a)}}),b.promise},_loadCapacities:function(a){console.log("_loadCapacities");var b=createIterationCapacityFilter(a.iterations),c=Ext.create("Deft.Deferred");return _loadAStoreWithAPromise("UserIterationCapacity",!0,b,{projectScopeDown:!1}).then({success:function(b){a.capacities=b,c.resolve(a)},failure:function(a){c.reject(a)}}),c.promise},uniqueCapacityUsers:function(a){var b=_.map(a.capacities,function(a){return a.get("User")}),c=_.uniq(_.map(b,function(a){return a._ref})),d=_.map(c,function(a){return _.find(b,function(b){return a===b._ref})}),e=_.compact(_.map(a.teamMembers,function(a){var b=_.find(d,function(b){return b._ref===a.get("_ref")});return b?null:{_ref:a.get("_ref"),_refObjectName:a.get("_refObjectName")}}));return _.sortBy(_.union(d,e),function(a){return a._refObjectName.toUpperCase()})},_createCapacityData:function(a){console.log("_createCapacityData");var b=Ext.create("Deft.Deferred");a.columns=[{id:"name",header:"Name",dataIndex:"name",width:250},{id:"total",header:"Total",dataIndex:"total",flex:1,width:100,renderer:function(a){return Ext.String.format('<div style="background-color:#EEEEEE">{0} h</div>',a)}}],a.fields=[{name:"name",type:"string"},{name:"userRef",type:"string"}];var c=function(a){return a.get("Name").replace(/\s+/g,"").replace(/\.+/g,"")},d=function(a){return c(a)+"CapacityRef"},e=function(a){return a>0?a:""},f=function(a){var b=a.get("StartDate"),c=a.get("EndDate");return a.get("Name")+"<br/>"+Ext.Date.format(b,app.extDateFormat)+" - "+Ext.Date.format(c,app.extDateFormat)+" ("+workingDaysBetweenDates(b,c)+")"};return _.each(a.iterations,function(b,g){a.fields.push({name:c(b),type:"number"}),a.fields.push({name:d(b),type:"object"}),a.columns.push({iterationRef:b.get("_ref"),id:c(b),header:f(b),dataIndex:c(b),flex:1,field:{},renderer:e,editor:{selectOnFocus:!0},summaryType:"sum",summaryRenderer:function(a,b,c){return Ext.String.format('<div style="background-color:#EEEEEE">{0} h</div>',a)}})}),a.fields.push({name:"total",type:"number",convert:function(b,c){var d=0;return _.each(a.fields,function(a){"total"!==a.name&&"number"===a.type&&(d+=c.data[a.name])}),d}}),a.model=Ext.define("userCapacity.Row",{extend:"Ext.data.Model",fields:a.fields}),a.data=_.map(app.uniqueCapacityUsers(a),function(b){var e=_.filter(a.capacities,function(a){return b._ref===a.get("User")._ref}),f=_.zipObject(_.map(a.iterations,function(a){return c(a)}),_.map(a.iterations,function(a){var b=_.find(e,function(b){return b.get("Iteration")._ref===a.get("_ref")});return b?b.get("Capacity"):null})),g=_.zipObject(_.map(a.iterations,function(a){return d(a)}),_.map(a.iterations,function(a){var b=_.find(e,function(b){return b.get("Iteration")._ref===a.get("_ref")});return b?b:null})),h=_.assign(f,g,{name:b._refObjectName,userRef:b._ref,total:0});return h}),a.store=Ext.create("Ext.data.Store",{model:a.model,autoLoad:!0,data:a.data,fields:_.map(a.fields,function(a){return a.name})}),b.resolve(a),b.promise},_createCapacityGrid:function(a){console.log("_createCapacityGrid");var b=Ext.create("Deft.Deferred");_.isNull(app.grid)||app.remove(app.grid);var c=Ext.create("Ext.grid.plugin.CellEditing",{clicksToEdit:1}),d=function(){var b=app.down("#userComboBox");if(null!==b.getValue){var d=b.getRecord(),e=_.find(a.store.data.items,function(a){return a.get("userRef")===d.get("_ref")});if(!e){var f=Ext.create("userCapacity.Row",{name:d.get("_refObjectName"),userRef:d.get("_ref")});a.store.insert(0,f),c.startEditByPosition({row:0,column:2})}}},e=function(b,c,d,e){var f=c.iterationRef,g=b.get("userRef"),h=b.get(c.id+"CapacityRef");d=""===d?0:d;var i=null;_.isUndefined(h)||_.isNull(h)||""===h?(i=Ext.create(a.userIterationCapacityModel,{Iteration:f,Project:app.getContext().getProject(),User:g}),i.set(c.id+"CapacityRef",i)):i=h,i.set("Capacity",d),i.save({callback:function(a,b){console.log(a,b),e(b.wasSuccessful())}})},f=function(){var b=app.down("#defaultCapacityValue").getValue();if(null!==b&&void 0!==b&&""!==b&&0!==b){var c=_.filter(app.grid.columns,function(a){return!_.isUndefined(a.iterationRef)}),d=[];a.store.data.each(function(a,e,f){var g=null;_.each(c,function(c){0===a.get(c.id)&&(g=_.isNull(g)?{record:a,cols:[]}:g,g.cols.push(c),a.set(c.id,b))}),_.isNull(g)||d.push(g)}),Ext.Msg.show({title:"Save Changes?",msg:"Are you sure you want to save these changes ?",buttons:Ext.Msg.YESNO,fn:function(a,b){"yes"===a?_.each(d,function(a){_.each(a.cols,function(b){e(a.record,b,a.record.get(b.id),function(b){a.record.commit()})})}):_.each(d,function(a){a.record.reject()})},animEl:"elId"})}},g=function(a,b){if(b.value!=b.originalValue){var c=""!==b.value?parseInt(b.value):0;return _.isNaN(c)||c>999?void b.record.reject():void e(b.record,b.column,c,function(a){a?(b.record.set("total",0),b.record.commit()):b.record.reject()})}};return app.grid=Ext.create("Ext.grid.Panel",{store:a.store,columns:a.columns,selModel:{selType:"cellmodel"},title:"Team Member Capacities",frame:!0,plugins:[c],features:[{ftype:"grouping",showSummaryRow:!0,groupHeaderTpl:" {name}"},{ftype:"summary"}],tbar:[{xtype:"rallyusersearchcombobox",project:app.getContext().getProject(),itemId:"userComboBox"},{text:"Add User",handler:d},{xtype:"textfield",itemId:"defaultCapacityValue"},{text:"Update Default",handler:f}]}),app.grid.on("edit",g),app.add(app.grid),b.resolve(a),b.promise},getSettingsFields:function(){return[{name:"maxIterations",xtype:"rallytextfield",boxLabelAlign:"after",fieldLabel:"Maximum number of iterations to show",margin:"0 0 15 50",labelStyle:"width:200px;",afterLabelTpl:'Enter a<span style="color:#999999;"><i> number </i></span> which represents the maximum number of iteration columns'}]}});
            
               Rally.launchApp('TSApp', {
                   name: 'team-capacity-bulk-update-enhanced'
               });
        });
    </script>
    
    <style type="text/css">

.app {
}
.tsinfolink {
    position:absolute;
    right:0px;
    width: 14px;
    height: 14px;
    border-radius: 7px;
    text-align: center;
    color: white;
    background: #C0C0C0;
    border-style: solid;
    border-width: 1px;
    margin-top: 25px;
    margin-right: 5px;
    cursor: pointer;
}
    </style>

</head>
<body></body>
</html>