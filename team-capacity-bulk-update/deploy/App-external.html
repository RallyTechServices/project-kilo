<!DOCTYPE html>
<html>
<head>
    <title>team-capacity-bulk-update</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                var _loadAStoreWithAPromise=function(model_name,model_fields,filters,ctx,order){var deferred=Ext.create("Deft.Deferred"),me=this,config={model:model_name,fetch:model_fields,filters:filters,limit:"Infinity"};return _.isUndefined(ctx)||_.isNull(ctx)||(config.context=ctx),_.isUndefined(order)||_.isNull(order)||(config.order=order),Ext.create("Rally.data.wsapi.Store",config).load({callback:function(records,operation,successful){successful?deferred.resolve(records):deferred.reject("Problem loading: "+operation.error.errors.join(". "))}}),deferred.promise},createIterationCapacityFilter=function(iterations){var filter=null;return _.each(iterations,function(iteration,x){var f=Ext.create("Rally.data.wsapi.Filter",{property:"Iteration",operator:"=",value:iteration.get("_ref")});filter=0===x?f:filter.or(f)}),console.log("Capacity Filter:",""+filter),filter},workingDaysBetweenDates=function(startDate,endDate){if(startDate>endDate)return 0;var millisecondsPerDay=864e5;startDate.setHours(0,0,0,1),endDate.setHours(23,59,59,999);var diff=endDate-startDate,days=Math.ceil(diff/millisecondsPerDay),weeks=Math.floor(days/7);days-=2*weeks;var startDay=startDate.getDay(),endDay=endDate.getDay();return startDay-endDay>1&&(days-=2),0==startDay&&6!=endDay&&(days-=1),6==endDay&&0!=startDay&&(days-=1),days};
                var app=null;Ext.define("CustomApp",{extend:"Rally.app.TimeboxScopedApp",componentCls:"app",scopeType:"release",devMode:!1,config:{defaultSettings:{maxIterations:5}},onScopeChange:function(scope){app=this,app.setupDateFormat();var maxIterations=parseInt(app.getSetting("maxIterations"));app.maxIterations=_.isNaN(maxIterations)?app.config.defaultSettings.maxIterations:maxIterations,console.log("scope",scope.getType(),scope),console.log("scope",scope.getRecord()),app.devMode===!0?app.release={Name:"Release 1",ReleaseDate:"2016-05-15T06:59:59.000Z",ReleaseStartDate:"2016-02-15T06:00:00.000Z"}:(app.release=_.isUndefined(scope)?null:scope.getRecord().raw,app.scope=scope),app.run()},setupDateFormat:function(){app.dformat=app.getContext().getWorkspace().WorkspaceConfiguration.DateFormat,app.extDateFormat="MM/dd/yyyy"===app.dformat?"m/d":"d/m"},run:function(){Deft.Chain.pipeline([this._getRelease,this._loadCapacityModel,this._loadReleases,this._loadIterations,this._loadTeamMembers,this._loadCapacities,this._createCapacityData,this._createCapacityGrid]).then({success:function(res){app.bundle=res,console.log(res)},failure:function(res){console.log("failure",res),app.add({text:res})}})},_getRelease:function(){console.log("_getRelease");var deferred=Ext.create("Deft.Deferred");return deferred.resolve({release:app.release,scope:app.scope}),deferred.promise},_loadCapacityModel:function(bundle){console.log("_loadCapacityModel");var deferred=Ext.create("Deft.Deferred");return Rally.data.ModelFactory.getModel({type:"UserIterationCapacity",success:function(model){bundle.userIterationCapacityModel=model,deferred.resolve(bundle)}}),deferred.promise},_loadReleases:function(bundle){console.log("_loadReleases",bundle);var release=bundle.release,deferred=Ext.create("Deft.Deferred");return _loadAStoreWithAPromise("Release",(!0)[{property:"Name",operator:"=",value:release.Name}]).then({success:function(records){bundle.releases=records,deferred.resolve(bundle)},failure:function(e){deferred.reject(e)}}),deferred.promise},createIterationQuery:function(scope){return"release"===scope.getType()?[{property:"EndDate",operator:"<=",value:scope.getRecord().get("ReleaseDate")},{property:"EndDate",operator:">",value:scope.getRecord().get("ReleaseStartDate")}]:[{property:"StartDate",operator:">=",value:scope.getRecord().get("StartDate")}]},_loadIterations:function(bundle){console.log("_loadIterations");var release=bundle.release,deferred=Ext.create("Deft.Deferred"),query=app.createIterationQuery(bundle.scope);return console.log("Iteration Query",query),_loadAStoreWithAPromise("Iteration",["Name","StartDate","EndDate"],query,{projectScopeDown:!1},"StartDate").then({success:function(records){records=_.sortBy(records,function(r){return r.get("StartDate")}),console.log(_.map(_.clone(records),function(r){return r.get("Name")})),"iteration"===bundle.scope.getType()&&(records=records.slice(0,app.maxIterations)),console.log("Iterations",records),bundle.iterations=records,console.log(_.map(records,function(r){return r.get("Name")})),records.length>0?deferred.resolve(bundle):deferred.reject("No iterations found")},failure:function(e){console.log("failure",e),deferred.reject(e)}}),deferred.promise},_loadTeamMembers:function(bundle){console.log("_loadTeamMembers");var deferred=Ext.create("Deft.Deferred");return _loadAStoreWithAPromise("Project",["Name","ObjectID","TeamMembers"],[{property:"ObjectID",operator:"=",value:app.getContext().getProject().ObjectID}],{projectScopeDown:!1},"EndDate").then({success:function(records){bundle.project=_.first(records),bundle.project.getCollection("TeamMembers").load({fetch:!0,callback:function(records,operation,success){success?(bundle.teamMembers=records,deferred.resolve(bundle)):deferred.reject("No TeamMembers")}})},failure:function(e){deferred.reject(e)}}),deferred.promise},_loadCapacities:function(bundle){console.log("_loadCapacities");var filter=createIterationCapacityFilter(bundle.iterations),deferred=Ext.create("Deft.Deferred");return _loadAStoreWithAPromise("UserIterationCapacity",!0,filter,{projectScopeDown:!1}).then({success:function(records){bundle.capacities=records,deferred.resolve(bundle)},failure:function(e){deferred.reject(e)}}),deferred.promise},uniqueCapacityUsers:function(bundle){var capacityUsers=_.map(bundle.capacities,function(capacity){return capacity.get("User")}),uniqCapacityUserRefs=_.uniq(_.map(capacityUsers,function(user){return user._ref})),uniqCapacityUsers=_.map(uniqCapacityUserRefs,function(userRef){return _.find(capacityUsers,function(capUser){return userRef===capUser._ref})}),teamMembersNoCapacity=_.compact(_.map(bundle.teamMembers,function(tm){var cu=_.find(uniqCapacityUsers,function(u){return u._ref===tm.get("_ref")});return cu?null:{_ref:tm.get("_ref"),_refObjectName:tm.get("_refObjectName")}}));return _.sortBy(_.union(uniqCapacityUsers,teamMembersNoCapacity),function(value){return value._refObjectName.toUpperCase()})},_createCapacityData:function(bundle){console.log("_createCapacityData");var deferred=Ext.create("Deft.Deferred");bundle.columns=[{id:"name",header:"Name",dataIndex:"name",width:250},{id:"total",header:"Total",dataIndex:"total",flex:1,width:100,renderer:function(value){return Ext.String.format('<div style="background-color:#EEEEEE">{0} h</div>',value)}}],bundle.fields=[{name:"name",type:"string"},{name:"userRef",type:"string"}];var shortName=function(i){return i.get("Name").replace(/\s+/g,"").replace(/\.+/g,"")},capacityRefName=function(i){return shortName(i)+"CapacityRef"},renderer=function(value){return value>0?value:""},iterationHeader=function(i){var start=i.get("StartDate"),end=i.get("EndDate");return i.get("Name")+"<br/>"+Ext.Date.format(start,app.extDateFormat)+" - "+Ext.Date.format(end,app.extDateFormat)+" ("+workingDaysBetweenDates(start,end)+")"};return _.each(bundle.iterations,function(i,x){bundle.fields.push({name:shortName(i),type:"number"}),bundle.fields.push({name:capacityRefName(i),type:"object"}),bundle.columns.push({iterationRef:i.get("_ref"),id:shortName(i),header:iterationHeader(i),dataIndex:shortName(i),flex:1,field:{},renderer:renderer,editor:{selectOnFocus:!0},summaryType:"sum",summaryRenderer:function(value,summaryData,dataIndex){return Ext.String.format('<div style="background-color:#EEEEEE">{0} h</div>',value)}})}),bundle.fields.push({name:"total",type:"number",convert:function(val,row){var x=0;return _.each(bundle.fields,function(f){"total"!==f.name&&"number"===f.type&&(x+=row.data[f.name])}),x}}),bundle.model=Ext.define("userCapacity.Row",{extend:"Ext.data.Model",fields:bundle.fields}),bundle.data=_.map(app.uniqueCapacityUsers(bundle),function(tm){var capacities=_.filter(bundle.capacities,function(c){return tm._ref===c.get("User")._ref}),zip1=_.zipObject(_.map(bundle.iterations,function(i){return shortName(i)}),_.map(bundle.iterations,function(i){var capacity=_.find(capacities,function(c){return c.get("Iteration")._ref===i.get("_ref")});return capacity?capacity.get("Capacity"):null})),zip2=_.zipObject(_.map(bundle.iterations,function(i){return capacityRefName(i)}),_.map(bundle.iterations,function(i){var capacity=_.find(capacities,function(c){return c.get("Iteration")._ref===i.get("_ref")});return capacity?capacity:null})),zip=_.assign(zip1,zip2,{name:tm._refObjectName,userRef:tm._ref,total:0});return zip}),bundle.store=Ext.create("Ext.data.Store",{model:bundle.model,autoLoad:!0,data:bundle.data,fields:_.map(bundle.fields,function(f){return f.name})}),deferred.resolve(bundle),deferred.promise},_createCapacityGrid:function(bundle){console.log("_createCapacityGrid");var deferred=Ext.create("Deft.Deferred");_.isNull(app.grid)||app.remove(app.grid);var cellEditing=Ext.create("Ext.grid.plugin.CellEditing",{clicksToEdit:1}),addUser=function(){var userSearch=app.down("#userComboBox");if(null!==userSearch.getValue){var record=userSearch.getRecord(),alreadyInStore=_.find(bundle.store.data.items,function(i){return i.get("userRef")===record.get("_ref")});if(!alreadyInStore){var r=Ext.create("userCapacity.Row",{name:record.get("_refObjectName"),userRef:record.get("_ref")});bundle.store.insert(0,r),cellEditing.startEditByPosition({row:0,column:2})}}},saveCapacityRecord=function(rec,column,value,callback){var iRef=column.iterationRef,uRef=rec.get("userRef"),cRef=rec.get(column.id+"CapacityRef");value=""===value?0:value;var record=null;_.isUndefined(cRef)||_.isNull(cRef)||""===cRef?(record=Ext.create(bundle.userIterationCapacityModel,{Iteration:iRef,Project:app.getContext().getProject(),User:uRef}),record.set(column.id+"CapacityRef",record)):record=cRef,record.set("Capacity",value),record.save({callback:function(result,operation){console.log(result,operation),callback(operation.wasSuccessful())}})},updateDefault=function(){var defaultValue=app.down("#defaultCapacityValue").getValue();if(null!==defaultValue&&void 0!==defaultValue&&""!==defaultValue&&0!==defaultValue){var iterationColumns=_.filter(app.grid.columns,function(col){return!_.isUndefined(col.iterationRef)}),recordsToCommit=[];bundle.store.data.each(function(item,index,totalItems){var rtc=null;_.each(iterationColumns,function(ic){0===item.get(ic.id)&&(rtc=_.isNull(rtc)?{record:item,cols:[]}:rtc,rtc.cols.push(ic),item.set(ic.id,defaultValue))}),_.isNull(rtc)||recordsToCommit.push(rtc)}),Ext.Msg.show({title:"Save Changes?",msg:"Are you sure you want to save these changes ?",buttons:Ext.Msg.YESNO,fn:function(btn,text){"yes"===btn?_.each(recordsToCommit,function(rtc){_.each(rtc.cols,function(col){saveCapacityRecord(rtc.record,col,rtc.record.get(col.id),function(success){rtc.record.commit()})})}):_.each(recordsToCommit,function(rtc){rtc.record.reject()})},animEl:"elId"})}},editUserCapacity=function(editor,e){if(e.value!=e.originalValue){var v=""!==e.value?parseInt(e.value):0;return _.isNaN(v)||v>999?(e.record.reject(),void 0):(saveCapacityRecord(e.record,e.column,v,function(success){success?(e.record.set("total",0),e.record.commit()):e.record.reject()}),void 0)}};return app.grid=Ext.create("Ext.grid.Panel",{store:bundle.store,columns:bundle.columns,selModel:{selType:"cellmodel"},title:"Team Member Capacities",frame:!0,plugins:[cellEditing],features:[{ftype:"grouping",showSummaryRow:!0,groupHeaderTpl:" {name}"},{ftype:"summary"}],tbar:[{xtype:"rallyusersearchcombobox",project:app.getContext().getProject(),itemId:"userComboBox"},{text:"Add User",handler:addUser},{xtype:"textfield",itemId:"defaultCapacityValue"},{text:"Update Default",handler:updateDefault}]}),app.grid.on("edit",editUserCapacity),app.add(app.grid),deferred.resolve(bundle),deferred.promise},getSettingsFields:function(){return[{name:"maxIterations",xtype:"rallytextfield",boxLabelAlign:"after",fieldLabel:"Maximum number of iterations to show",margin:"0 0 15 50",labelStyle:"width:200px;",afterLabelTpl:'Enter a<span style="color:#999999;"><i> number </i></span> which represents the maximum number of iteration columns'}]}});

            Rally.launchApp('CustomApp', {
                name:"team-capacity-bulk-update",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
